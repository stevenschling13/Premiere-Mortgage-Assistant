generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  OWNER
  ADMIN
  LOAN_OFFICER
  PROCESSOR
  READ_ONLY
}

enum UserStatus {
  ACTIVE
  INVITED
  DISABLED
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  DISQUALIFIED
  CONVERTED
}

enum LoanStatus {
  DRAFT
  SUBMITTED
  PROCESSING
  CONDITIONAL_APPROVAL
  CLEAR_TO_CLOSE
  FUNDED
  WITHDRAWN
  DENIED
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ConversationChannel {
  ASSISTANT
  CHAT
  EMAIL
  CALL
}

enum WorkflowTriggerType {
  STATUS_CHANGE
  TIME_BASED
  INTERACTION_LOG
}

enum OutboundEventStatus {
  PENDING
  DELIVERED
  FAILED
}

model Organization {
  id        String   @id @default(uuid())
  name      String
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users              User[]
  leads              Lead[]
  borrowers          Borrower[]
  loanApplications   LoanApplication[]
  tasks              Task[]
  notes              Note[]
  conversations      Conversation[]
  workflowRules      WorkflowRule[]
  outboundEvents     OutboundEvent[]
  webhookSubscriptions WebhookSubscription[]

  @@unique([name])
}

model User {
  id             String    @id @default(uuid())
  organizationId String
  email          String
  name           String
  role           UserRole
  status         UserStatus @default(ACTIVE)
  passwordHash   String
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  leads        Lead[]       @relation("LeadAssignee")
  tasks        Task[]       @relation("TaskAssignee")
  notes        Note[]       @relation("NoteAuthor")

  @@unique([email, organizationId])
  @@index([organizationId])
}

model Borrower {
  id                String   @id @default(uuid())
  organizationId    String
  primaryContact    Json
  coBorrowerInfo    Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  loanApplications LoanApplication[]
  tasks            Task[]
  notes            Note[]
  conversations    Conversation[]

  @@index([organizationId])
}

model Lead {
  id               String    @id @default(uuid())
  organizationId   String
  source           String?
  status           LeadStatus @default(NEW)
  assignedUserId   String?
  metadata         Json?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  assignedUser User?        @relation("LeadAssignee", fields: [assignedUserId], references: [id])
  tasks        Task[]
  notes        Note[]
  conversations Conversation[]

  @@index([organizationId])
  @@index([assignedUserId])
}

model LoanApplication {
  id               String   @id @default(uuid())
  organizationId   String
  borrowerId       String
  leadId           String?
  loanType         String
  amount           Decimal   @db.Decimal(12,2)
  status           LoanStatus @default(DRAFT)
  stageHistory     Json
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  borrower     Borrower     @relation(fields: [borrowerId], references: [id])
  lead         Lead?        @relation(fields: [leadId], references: [id])
  tasks        Task[]
  notes        Note[]
  conversations Conversation[]

  @@index([organizationId])
  @@index([borrowerId])
}

model Task {
  id                 String    @id @default(uuid())
  organizationId     String
  relatedEntityType  String
  relatedEntityId    String
  title              String
  description        String?
  status             TaskStatus @default(OPEN)
  dueDate            DateTime?
  assignedUserId     String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  assignedUser User?        @relation("TaskAssignee", fields: [assignedUserId], references: [id])

  @@index([organizationId])
  @@index([assignedUserId])
}

model Note {
  id                 String   @id @default(uuid())
  organizationId     String
  relatedEntityType  String
  relatedEntityId    String
  authorUserId       String
  body               String
  createdAt          DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  author       User         @relation("NoteAuthor", fields: [authorUserId], references: [id])

  @@index([organizationId])
  @@index([authorUserId])
}

model Conversation {
  id                 String   @id @default(uuid())
  organizationId     String
  relatedEntityType  String
  relatedEntityId    String
  channel            ConversationChannel
  messages           Json
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
}

model WorkflowRule {
  id             String   @id @default(uuid())
  organizationId String
  triggerType    WorkflowTriggerType
  triggerConfig  Json
  actionConfig   Json
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
}

model OutboundEvent {
  id             String   @id @default(uuid())
  organizationId String
  eventType      String
  payload        Json
  status         OutboundEventStatus @default(PENDING)
  retryCount     Int      @default(0)
  lastError      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
}

model WebhookSubscription {
  id             String   @id @default(uuid())
  organizationId String
  eventType      String
  targetUrl      String
  secret         String
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, eventType, targetUrl])
  @@index([organizationId])
}
